<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="auth-screen" class="screen">
        <h2>Register / Login</h2>
        <input type="text" id="auth-username" placeholder="Enter username" required>
        <input type="password" id="auth-password" placeholder="Enter password" required>
        <button onclick="register()">Register</button>
        <button onclick="login()">Login</button>
    </div>

    <div id="chat-screen" class="screen hidden">
        <div class="chat-container">
            <h2>Live Chat</h2>
            <button class="logout-btn" onclick="logout()">Logout</button>
            <div id="chat-box"></div>
            <input type="text" id="message" placeholder="Type a message..." required>
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = "your-supabase-url";
        const SUPABASE_ANON_KEY = "your-supabase-anon-key";
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const authScreen = document.getElementById("auth-screen");
        const chatScreen = document.getElementById("chat-screen");
        const chatBox = document.getElementById("chat-box");
        const messageInput = document.getElementById("message");

        async function register() {
            const username = document.getElementById("auth-username").value;
            const password = document.getElementById("auth-password").value;

            if (!username || !password) {
                alert("Please enter a username and password.");
                return;
            }

            const { data, error } = await supabase.auth.signUp({
                email: `${username}@chatapp.com`,
                password: password
            });

            if (error) {
                alert("Registration failed: " + error.message);
            } else {
                alert("Registration successful! Please log in.");
            }
        }

        async function login() {
            const username = document.getElementById("auth-username").value;
            const password = document.getElementById("auth-password").value;

            if (!username || !password) {
                alert("Please enter both username and password.");
                return;
            }

            const { data, error } = await supabase.auth.signInWithPassword({
                email: `${username}@chatapp.com`,
                password: password
            });

            if (error) {
                alert("Invalid login. Please try again.");
            } else {
                sessionStorage.setItem("username", username);
                authScreen.classList.add("hidden");
                chatScreen.classList.remove("hidden");
                loadMessages();
            }
        }

        async function sendMessage() {
            const username = sessionStorage.getItem("username");
            const message = messageInput.value.trim();
            if (!message) return;

            await supabase.from("messages").insert([{ username, message }]);
            messageInput.value = "";
        }

        supabase.channel("chat-room")
            .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, payload => {
                displayMessage(payload.new.username, payload.new.message);
            })
            .subscribe();

        function displayMessage(username, msg) {
            const newMessage = document.createElement("p");
            newMessage.textContent = `${username}: ${msg}`;
            chatBox.appendChild(newMessage);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function loadMessages() {
            const { data } = await supabase.from("messages").select("*").order("timestamp", { ascending: true });
            data.forEach(msg => displayMessage(msg.username, msg.message));
        }

        function logout() {
            sessionStorage.removeItem("username");
            authScreen.classList.remove("hidden");
            chatScreen.classList.add("hidden");
        }
    </script>
</body>
</html>
